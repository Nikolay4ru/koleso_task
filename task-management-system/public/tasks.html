<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление задачами</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8; 
            --secondary: #764ba2;
            --success: #48bb78;
            --warning: #f6ad55;
            --danger: #f56565;
            --info: #4299e1;
            --dark: #2d3748;
            --gray: #718096;
            --gray-light: #e2e8f0;
            --gray-lighter: #f7fafc;
            --white: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            color: var(--dark);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--gray-lighter);
            border: none;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn:hover {
            background: var(--gray-light);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 2px solid var(--gray-light);
            border-radius: 20px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: var(--gray-lighter);
            border-radius: var(--radius);
            padding: 0.25rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .view-btn.active {
            background: white;
            box-shadow: var(--shadow);
        }

        /* Kanban View */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kanban-column {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-light);
        }

        .column-title {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .column-count {
            background: var(--gray-lighter);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--gray);
        }

        .column-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Task Card */
        .task-card {
            background: var(--gray-lighter);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            background: white;
        }

        .task-card.dragging {
            opacity: 0.5;
        }

        .task-header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .task-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .task-card:hover .task-actions {
            opacity: 1;
        }

        .task-action-btn {
            background: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .task-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        .task-description {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-people {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .task-person {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: white;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .person-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .task-meta-left {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .priority-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-low { background: #c6f6d5; color: #22543d; }
        .priority-medium { background: #bee3f8; color: #2c5282; }
        .priority-high { background: #fed7d7; color: #742a2a; }
        .priority-urgent { background: #f56565; color: white; }

        .task-deadline {
            font-size: 0.75rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .task-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* List View */
        .list-view {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .list-header {
            display: grid;
            grid-template-columns: 2fr 1fr 150px 150px 120px 150px 100px;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--gray-lighter);
            font-weight: 600;
            color: var(--gray);
            font-size: 0.875rem;
        }

        .list-item {
            display: grid;
            grid-template-columns: 2fr 1fr 150px 150px 120px 150px 100px;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-light);
            align-items: center;
            transition: var(--transition);
            text-decoration: none;
            color: inherit;
        }

        .list-item:hover {
            background: var(--gray-lighter);
        }

        .list-title {
            font-weight: 500;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .list-people {
            display: flex;
            gap: -0.5rem;
        }

        .list-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border: 2px solid white;
        }

        .list-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
        }

        .status-backlog { background: var(--gray-light); color: var(--gray); }
        .status-todo { background: #bee3f8; color: #2c5282; }
        .status-in-progress { background: #fbd38d; color: #744210; }
        .status-review { background: #c6b2f3; color: #553c9a; }
        .status-done { background: #9ae6b4; color: #22543d; }

        .list-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .empty-description {
            color: var(--gray);
            margin-bottom: 2rem;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .stat-up { color: var(--success); }
        .stat-down { color: var(--danger); }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .kanban-board {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .list-header,
            .list-item {
                grid-template-columns: 2fr 1fr 100px 100px 80px;
            }

            .list-header > *:nth-child(6),
            .list-header > *:nth-child(7),
            .list-item > *:nth-child(6),
            .list-item > *:nth-child(7) {
                display: none;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header-top {
                flex-direction: column;
                gap: 1rem;
            }

            .filters {
                flex-direction: column;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .list-header,
            .list-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .list-item > * {
                padding: 0.25rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>📋 Управление задачами</h1>
                <div class="header-actions">
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="setView('kanban')">
                            Канбан
                        </button>
                        <button class="view-btn" onclick="setView('list')">
                            Список
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="createNewTask()">
                        ➕ Новая задача
                    </button>
                </div>
            </div>

            <div class="filters">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Поиск задач..." onkeyup="searchTasks(event)">
                    <span class="search-icon">🔍</span>
                </div>
                
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterByStatus('all')">Все</button>
                    <button class="filter-btn" onclick="filterByStatus('backlog')">Бэклог</button>
                    <button class="filter-btn" onclick="filterByStatus('todo')">К выполнению</button>
                    <button class="filter-btn" onclick="filterByStatus('in-progress')">В работе</button>
                    <button class="filter-btn" onclick="filterByStatus('done')">Выполнено</button>
                </div>

                <div class="filter-group">
                    <button class="filter-btn" onclick="filterByPriority('urgent')">🔴 Срочные</button>
                    <button class="filter-btn" onclick="filterByPriority('high')">🟡 Высокий</button>
                    <button class="filter-btn" onclick="filterByAssignee()">👤 Мои задачи</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Всего задач</div>
                <div class="stat-value" id="totalTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">В работе</div>
                <div class="stat-value" id="inProgressTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Выполнено за неделю</div>
                <div class="stat-value" id="completedWeek">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Просроченные</div>
                <div class="stat-value" id="overdueTasks" style="color: var(--danger);">0</div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        const API_URL = window.location.origin + '/api';
        let currentView = 'kanban';
        let tasks = [];
        let filteredTasks = [];
        let currentUser = null;
        let users = [];
        let currentFilter = { status: 'all', priority: null, assignee: null, search: '' };

        // Инициализация
        async function init() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                // Загружаем текущего пользователя
                const userResponse = await fetch(`${API_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!userResponse.ok) {
                    throw new Error('Ошибка аутентификации');
                }

                currentUser = await userResponse.json();

                // Загружаем пользователей
                const usersResponse = await fetch(`${API_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (usersResponse.ok) {
                    users = await usersResponse.json();
                }

                // Загружаем задачи
                await loadTasks();

            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showError('Ошибка загрузки данных');
            }
        }

        // Загрузка задач
        async function loadTasks() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/tasks`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки задач');
                }

                tasks = await response.json();
                applyFilters();
                updateStats();
                renderTasks();

            } catch (error) {
                console.error('Ошибка загрузки задач:', error);
                showError('Не удалось загрузить задачи');
            }
        }

        // Применение фильтров
        function applyFilters() {
            filteredTasks = tasks.filter(task => {
                // Фильтр по статусу
                if (currentFilter.status !== 'all' && task.status !== currentFilter.status) {
                    return false;
                }

                // Фильтр по приоритету
                if (currentFilter.priority && task.priority !== currentFilter.priority) {
                    return false;
                }

                // Фильтр по исполнителю
                if (currentFilter.assignee === 'me' && 
                    (!task.assignees || !task.assignees.includes(currentUser.id))) {
                    return false;
                }

                // Поиск
                if (currentFilter.search) {
                    const search = currentFilter.search.toLowerCase();
                    return task.title.toLowerCase().includes(search) ||
                           (task.description && task.description.toLowerCase().includes(search));
                }

                return true;
            });
        }

        // Обновление статистики
        function updateStats() {
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('inProgressTasks').textContent = 
                tasks.filter(t => t.status === 'in-progress').length;
            
            // Выполнено за неделю
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('completedWeek').textContent = 
                tasks.filter(t => 
                    t.status === 'done' && 
                    new Date(t.updatedAt) > weekAgo
                ).length;
            
            // Просроченные
            const today = new Date();
            document.getElementById('overdueTasks').textContent = 
                tasks.filter(t => 
                    t.dueDate && 
                    new Date(t.dueDate) < today && 
                    t.status !== 'done'
                ).length;
        }

        // Отрисовка задач
        function renderTasks() {
            const contentArea = document.getElementById('contentArea');
            
            if (filteredTasks.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📭</div>
                        <div class="empty-title">Нет задач</div>
                        <div class="empty-description">
                            Создайте первую задачу или измените фильтры
                        </div>
                        <button class="btn btn-primary" onclick="createNewTask()">
                            Создать задачу
                        </button>
                    </div>
                `;
                return;
            }

            if (currentView === 'kanban') {
                renderKanbanView();
            } else {
                renderListView();
            }
        }

        // Канбан представление
        function renderKanbanView() {
            const columns = {
                'backlog': { title: '📋 Бэклог', tasks: [] },
                'todo': { title: '📝 К выполнению', tasks: [] },
                'in-progress': { title: '⚡ В работе', tasks: [] },
                'review': { title: '👀 На проверке', tasks: [] },
                'done': { title: '✅ Выполнено', tasks: [] }
            };

            filteredTasks.forEach(task => {
                if (columns[task.status]) {
                    columns[task.status].tasks.push(task);
                }
            });

            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="kanban-board">
                    ${Object.entries(columns).map(([status, column]) => `
                        <div class="kanban-column" data-status="${status}">
                            <div class="column-header">
                                <div class="column-title">
                                    ${column.title}
                                </div>
                                <span class="column-count">${column.tasks.length}</span>
                            </div>
                            <div class="column-content" ondrop="handleDrop(event, '${status}')" ondragover="handleDragOver(event)">
                                ${column.tasks.map(task => createTaskCard(task)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Список представление
        function renderListView() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="list-view">
                    <div class="list-header">
                        <div>Название</div>
                        <div>Исполнители</div>
                        <div>Статус</div>
                        <div>Приоритет</div>
                        <div>Срок</div>
                        <div>Создана</div>
                        <div>Действия</div>
                    </div>
                    ${filteredTasks.map(task => createListItem(task)).join('')}
                </div>
            `;
        }

        // Создание карточки задачи
        function createTaskCard(task) {
            const assignees = task.assignees || [];
            const watchers = task.watchers || [];
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && task.status !== 'done';

            return `
                <a href="/task/${task.id}" class="task-card" draggable="true" ondragstart="handleDragStart(event, ${task.id})" target="_blank">
                    <div class="task-header-row">
                        <div class="task-title">${escapeHtml(task.title)}</div>
                    </div>
                    ${task.description ? `
                        <div class="task-description">${escapeHtml(task.description)}</div>
                    ` : ''}
                    ${assignees.length > 0 || watchers.length > 0 ? `
                        <div class="task-people">
                            ${assignees.map(userId => {
                                const user = users.find(u => u.id === userId);
                                return user ? `
                                    <div class="task-person">
                                        <div class="person-avatar">
                                            ${user.name ? user.name[0].toUpperCase() : 'U'}
                                        </div>
                                        <span>${user.name}</span>
                                    </div>
                                ` : '';
                            }).join('')}
                            ${watchers.length > 0 ? `
                                <div class="task-person" style="background: var(--gray-lighter);">
                                    <span>👁️ ${watchers.length}</span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    <div class="task-meta">
                        <div class="task-meta-left">
                            <span class="priority-badge priority-${task.priority}">
                                ${getPriorityText(task.priority)}
                            </span>
                            ${dueDate ? `
                                <div class="task-deadline ${isOverdue ? 'overdue' : ''}">
                                    📅 ${dueDate.toLocaleDateString('ru')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="task-stats">
                            <div class="task-stat">💬 ${task.commentsCount || 0}</div>
                            <div class="task-stat">📎 ${task.filesCount || 0}</div>
                        </div>
                    </div>
                </a>
            `;
        }

        // Создание элемента списка
        function createListItem(task) {
            const assignees = task.assignees || [];
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;

            return `
                <a href="/task/${task.id}" class="list-item" target="_blank">
                    <div class="list-title">
                        ${escapeHtml(task.title)}
                    </div>
                    <div class="list-people">
                        ${assignees.slice(0, 3).map(userId => {
                            const user = users.find(u => u.id === userId);
                            return user ? `
                                <div class="list-avatar" title="${user.name}">
                                    ${user.name ? user.name[0].toUpperCase() : 'U'}
                                </div>
                            ` : '';
                        }).join('')}
                        ${assignees.length > 3 ? `
                            <div class="list-avatar">+${assignees.length - 3}</div>
                        ` : ''}
                    </div>
                    <div>
                        <span class="list-status status-${task.status}">
                            ${getStatusText(task.status)}
                        </span>
                    </div>
                    <div>
                        <span class="priority-badge priority-${task.priority}">
                            ${getPriorityText(task.priority)}
                        </span>
                    </div>
                    <div>
                        ${dueDate ? dueDate.toLocaleDateString('ru') : '-'}
                    </div>
                    <div>
                        ${new Date(task.createdAt).toLocaleDateString('ru')}
                    </div>
                    <div class="list-actions">
                        <button class="task-action-btn" onclick="event.preventDefault(); openTask(${task.id})">
                            👁️
                        </button>
                        <button class="task-action-btn" onclick="event.preventDefault(); duplicateTask(${task.id})">
                            📋
                        </button>
                    </div>
                </a>
            `;
        }

        // Создание новой задачи
        function createNewTask() {
            window.open('/task/new', '_blank');
        }

        // Открыть задачу
        function openTask(taskId) {
            window.open(`/task/${taskId}`, '_blank');
        }

        // Дублировать задачу
        async function duplicateTask(taskId) {
            if (!confirm('Создать копию задачи?')) return;

            try {
                const token = localStorage.getItem('token');
                const task = tasks.find(t => t.id === taskId);
                
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...task,
                        title: task.title + ' (копия)',
                        id: undefined,
                        createdAt: undefined,
                        updatedAt: undefined,
                        status: 'backlog'
                    })
                });

                if (!response.ok) throw new Error('Ошибка создания');

                const newTask = await response.json();
                await loadTasks();
                alert('Задача успешно скопирована');

            } catch (error) {
                console.error('Ошибка дублирования:', error);
                alert('Не удалось создать копию задачи');
            }
        }

        // Drag & Drop для Канбан
        let draggedTaskId = null;

        function handleDragStart(event, taskId) {
            draggedTaskId = taskId;
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        async function handleDrop(event, newStatus) {
            event.preventDefault();
            
            if (!draggedTaskId) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/tasks/${draggedTaskId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('Ошибка обновления');

                // Обновляем локальные данные
                const task = tasks.find(t => t.id === draggedTaskId);
                if (task) {
                    task.status = newStatus;
                    task.updatedAt = new Date().toISOString();
                }

                renderTasks();
                updateStats();

            } catch (error) {
                console.error('Ошибка обновления статуса:', error);
                alert('Не удалось обновить статус задачи');
            } finally {
                draggedTaskId = null;
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });
            }
        }

        // Фильтры
        function setView(view) {
            currentView = view;
            
            // Обновляем кнопки
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderTasks();
        }

        function filterByStatus(status) {
            currentFilter.status = status;
            
            // Обновляем кнопки
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
            renderTasks();
        }

        function filterByPriority(priority) {
            currentFilter.priority = currentFilter.priority === priority ? null : priority;
            event.target.classList.toggle('active');
            
            applyFilters();
            renderTasks();
        }

        function filterByAssignee() {
            currentFilter.assignee = currentFilter.assignee === 'me' ? null : 'me';
            event.target.classList.toggle('active');
            
            applyFilters();
            renderTasks();
        }

        function searchTasks(event) {
            currentFilter.search = event.target.value;
            applyFilters();
            renderTasks();
        }

        // Вспомогательные функции
        function getStatusText(status) {
            const statuses = {
                'backlog': 'Бэклог',
                'todo': 'К выполнению',
                'in-progress': 'В работе',
                'review': 'На проверке',
                'done': 'Выполнено'
            };
            return statuses[status] || status;
        }

        function getPriorityText(priority) {
            const priorities = {
                'low': 'Низкий',
                'medium': 'Средний',
                'high': 'Высокий',
                'urgent': 'Срочный'
            };
            return priorities[priority] || priority;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function showError(message) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">⚠️</div>
                    <div class="empty-title">Ошибка</div>
                    <div class="empty-description">${message}</div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        Обновить страницу
                    </button>
                </div>
            `;
        }

        // WebSocket для real-time обновлений
        function connectWebSocket() {
            const socket = io();
            
            socket.on('connect', () => {
                const token = localStorage.getItem('token');
                socket.emit('authenticate', token);
            });

            socket.on('task_created', (task) => {
                tasks.unshift(task);
                applyFilters();
                updateStats();
                renderTasks();
            });

            socket.on('task_updated', (updatedTask) => {
                const index = tasks.findIndex(t => t.id === updatedTask.id);
                if (index !== -1) {
                    tasks[index] = updatedTask;
                    applyFilters();
                    updateStats();
                    renderTasks();
                }
            });

            socket.on('task_deleted', ({ id }) => {
                tasks = tasks.filter(t => t.id !== id);
                applyFilters();
                updateStats();
                renderTasks();
            });
        }

        // Запуск при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            init();
            connectWebSocket();
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>
</body>
</html>